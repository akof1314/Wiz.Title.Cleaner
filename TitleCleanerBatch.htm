<html>
<head>
    <title>Title Cleaner Batch</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="zTree/css/demo.css" type="text/css">
	<link rel="stylesheet" href="zTree/css/zTreeStyle/zTreeStyle.css" type="text/css">
	<script type="text/javascript" src="zTree/js/jquery-1.4.4.min.js"></script>
	<script type="text/javascript" src="zTree/js/jquery.ztree.core-3.5.min.js"></script>
	<SCRIPT type="text/javascript">
		<!--
		var setting = {
			view: {
				nameIsHTML: true
			}
		};

		var zNodes =[
		];

		var zTreeObj = null;
		var objApp = window.external;
		var objCommon = null;
		var objDatabase = null;
		var objWindow = null;
		var strPluginPath = "";
		var strBlackListPath = "";
		var arrBlackList = null;

		$(document).ready(function(){
			strPluginPath = objApp.GetPluginPathByScriptFileName("TitleCleaner.js");
			strBlackListPath = strPluginPath + "BlackList.txt";
			objCommon = objApp.CreateWizObject("WizKMControls.WizCommonUI");
			objDatabase = objApp.Database;
			objWindow = objApp.Window;
			$("#rulenameBlackList").val(strBlackListPath);
		});

		function TitleCleaner_GetHeader(src)
		{
		    return objCommon.LoadTextFromFile(src);
		}

		function TitleCleaner_ReadText()
		{
		    var arr = TitleCleaner_GetHeader(TitleCleaner_pluginPath + "BlackList.txt").split("\n");

		    for (var i = 0; i < arr.length; i++)
		    {
		        var objDoc = objWindow.CurrentDocument;
		        if (objDoc == null)
		        {
		            return;
		        }
		        else
		        {
		            var arrBL = TitleCleaner_splitBlackListItem(arr[i]);

		            if (arrBL.length == 1)
		            {
		                var reg = new RegExp(arrBL[0], "gmi");
		                objDoc.Title = objDoc.Title.replace(reg, "");
		            }
		            else
		            {
		                var reg = new RegExp(arrBL[0], "gmi");
		                objDoc.Title = objDoc.Title.replace(reg, arrBL[1]);
		            }
		        }
		    }
		}

		function TitleCleaner_splitBlackListItem(BLI)
		{
		    var arrBLSP = new Array();
		    arrBLSP = BLI.split('^^');
		    return arrBLSP;
		}

		function previewTitleCleaner () {
			getBlackList();
			zNodes = [];
			addChildDocs(objDatabase, zNodes);

			zTreeObj = $.fn.zTree.init($("#treeDemo"), setting, zNodes);
			$("#buttonDo").removeAttr("disabled");
		}

		function doTitleCleaner () {
			console.log(TitleCleaner_pluginPath);
		}

		function addChildDocs(parentFolder, parentNode) {
			var childrenFolders = parentFolder.Folders;
			if (childrenFolders){
				for (var i = 0; i < childrenFolders.Count; i++) {
					var childrenFolder = childrenFolders.Item(i);

					var childrenNode = [];
					if (addChildDocs(childrenFolder, childrenNode)) {
						parentNode.push({name:childrenFolder.GetDisplayName(0),
						  icon:getIconFileRealPath(childrenFolder.GetIconFileName()),
						  open:true,
						  children:childrenNode});
					}
				}
			}

			var childrenDocs = parentFolder.Documents;
			if (childrenDocs){
				for (var i = 0; i < childrenDocs.Count; i++) {
					var childrenDoc = childrenDocs.Item(i);
					var childrenDocTitle = childrenDoc.Title;

					for (var j = 0; j < arrBlackList.length; j++) {
						if (new RegExp(arrBlackList[j][0], "gmi").test(childrenDocTitle) == true) {
							parentNode.push({name:"<span style='color:blue;margin-right:0px;'>" + childrenDocTitle + "</span>",
							 icon:getIconFileRealPath(childrenDoc.GetIconFileName())});

							break;
						}
					};
				}
			}
			return parentNode.length > 0;
		}

		function getIconFileRealPath (fileName) {
			return fileName.replace(/\\/g, "/").replace(/ /g, "%20");
		}

		function getBlackList () {
			arrBlackList = [];
			var arrList = objCommon.LoadTextFromFile(strBlackListPath).split("\n");
			for (var i = 0; i < arrList.length; i++) {
				var arrItem = arrList[i].split('^^');
				if (arrItem.length == 1) {
					arrItem.push("");
				};

				arrBlackList.push(arrItem);
			};
		}

		//-->
	</SCRIPT>
    </htad>
    <body>
	<table style="width:100%;height:100%;table-layout:fixed;padding: 10px;">
        <tr>
			<td colspan="2" >
				规则文件: <input id="rulenameBlackList" type="text" readonly="true" name="rulename" style="width:70%;"/>
			</td>
            <td align="right">
				<input id="buttonPreview" type="button" value="预览" onclick="previewTitleCleaner();" style="width: 70px; padding-top:3px;" />
				<input id="buttonDo" type="button" disabled="disabled" value="清理" onclick="doTitleCleaner();" style="width: 70px; padding-top:3px;" />
			</td>
        </tr>
		<tr>
            <td colspan="3" style="width:100%;height:100%;">
				<ul id="treeDemo" class="ztree"></ul>
            </td>
        </tr>
    </table>
    </body>
</html>
